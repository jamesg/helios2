<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Photograph Album - Photograph</title>
        <link rel="stylesheet" href="grid.css">
        <link rel="stylesheet" href="modal.css">
        <link rel="stylesheet" href="style.css">
        <link rel="stylesheet" href="teletype-theme.css">
    </head>
    <body>
        <div id="modal-container"></div>
        <div class="grid">
            <div class="col-4-4 photograph-container">
                <span class="back-link"><a href="albums.html" id="back-a">Back to album</a></span>
                <div id="photograph-view"></div>
                <ul class="photograph-list photograph-list-small" id="photograph-list"></ul>
                <div id="photograph-details"></div>
            </div>
            <div class="col-2-4">
                <ul id="tag-list" class="tag-list"></ul>
                <form id="add-tag-form">
                    <input name="tag" type="text" autocomplete="off"></input>
                    <button type="submit">Add</button>
                </form>
            </div>
            <div class="col-2-4">
                <ul id="album-list" class="album-list"></ul>
                <form id="add-album-form">
                    <select name="album" id="album-select"></select>
                    <button type="submit">Add</button>
                </form>
            </div>
        </div>
        <script src="jquery.js"></script>
        <script src="underscore.js"></script>
        <script src="backbone.js"></script>
        <script src="views.js"></script>
        <script src="modal.js"></script>
        <script src="application.js"></script>
        <script type="text/javascript">
var PhotographView = StaticView.extend({
    template: '<div class="photograph">' +
        '<img src="/photograph/medium/<%-id%>" alt="<%-title%>"></img>' +
        '</div>',
});

var PhotographDetailsView = StaticView.extend({
    template:
        '<h2><%-title%></h2><button name="edit">Edit</button><br>' +
        '<span class="caption"><%-caption%></span><br>' +
        '<span class="size-link">' +
        '<a href="/photograph/original/<%-id%>">Full size</a>' +
        '</span>',
    events: {
        'click button[name=edit]': function() {
            (new Modal({
                view: PhotographFormView,
                model: this.model,
                buttons: [
                    StandardButton.cancel(),
                    StandardButton.destroy(
                        function() {
                            new ConfirmModal(
                                    {
                                        message: 'Are you sure you want to delete this photograph?',
                                        callback: (function() {
                                            this.model.destroy();
                                            this.remove();
                                        }).bind(this)
                                    }
                                    );
                        }
                        ),
                    StandardButton.save(
                        function() {
                            this.view.save();
                            this.remove();
                        }
                        )
                ]
            }));
        }
    }
});

$(document).ready(
    function() {
        var photograph = new Photograph();
        var albumPhotographs = new PhotographCollection;
        var tags = new TagCollection;
        var allAlbums = new AlbumCollection;
        allAlbums.fetch();
        var photographAlbums = new AlbumCollection;

        var photographId, albumId;

        var hashChange = function() {
            var params = window.location.hash.substr(1).split('.');
            photographId = params[0];
            albumId = coalesce(params[1], 'uncategorised');
            photograph.set('id', photographId);
            photograph.fetch();
            albumPhotographs.url = '/api/album_photograph/' + albumId;
            albumPhotographs.fetch({ reset: true });
            tags.url = '/api/photograph_tag/' + photograph.id;
            tags.fetch({ reset: true });
            photographAlbums.url = '/api/photograph_album/' + photograph.id;
            photographAlbums.fetch({ reset: true });
        };

        hashChange();
        window.onhashchange = hashChange;

        (new CollectionView({
            el: $('#album-select'),
            model: allAlbums,
            view: StaticView.extend({
                tagName: 'option',
                attributes: function() {
                    console.log('attributes', this);
                    return { value: this.model.id };
                },
                template: '<%-name%>'
            })
        })).render();

        $('#back-a').attr('href', '/albums.html#' + albumId);
        var photographView = new PhotographView({
            el: $('#photograph-view'),
            model: photograph
        });

        var photographDetailsView = new PhotographDetailsView({
            el: $('#photograph-details'),
            model: photograph
        });

        (new CollectionView({
            view: ThumbnailView,
            el: $('#photograph-list'),
            model: albumPhotographs,
            initializeView: function(view) {
                view.targetUrl = '/photograph.html#' + view.model.id + '.' + albumId;
            },
            filter: function(model) {
                var middleIndex = _.findIndex(
                        this.model.models,
                        function(m) { return m.id == photograph.id; }
                        );
                // Allow two thumbnails either side of this one.
                return (Math.abs(this.model.indexOf(model) - middleIndex) < 4);
            }
        })).render();

        (new CollectionView({
            el: $('#tag-list'),
            model: tags,
            view: StaticView.extend({
                tagName: 'li',
                template: '<span class="tag"><%-tag%></span><button>Remove</button>',
                events: {
                    'click button': function() {
                        tags.remove(this.model);
                        tags.sync('update', tags);
                    }
                }
            })
        })).render();
        $('#add-tag-form').submit(
                function(event) {
                    event.preventDefault();
                    var tag = $('input[name=tag]').val();
                    console.log('add tag', tag);
                    <!--if(tags.where({ tag: tag }) != [])-->
                        <!--return;-->
                    tags.add({ tag: tag });
                    tags.sync('update', tags);
                    <!--tags.fetch();-->
                    $('input[name=tag]').val('');
                    $('input[name=tag]').focus();
                }
                );

        (new CollectionView({
            el: $('#album-list'),
            model: photographAlbums,
            view: StaticView.extend({
                tagName: 'li',
                template: '<span class="album-name"><%-name%></span><button>Remove</button>',
                events: {
                    'click button': function() {
                        photographAlbums.remove(this.model);
                        photographAlbums.sync('update', photographAlbums);
                    }
                }
            })
        })).render();
        $('#add-album-form').submit(
                function(event) {
                    event.preventDefault();
                    var albumId = $('select[name=album]').val();
                    var album = allAlbums.find(function(model) { return model.id == albumId; });
                    console.log(allAlbums);
                    console.log('add album', albumId, album);
                    photographAlbums.add(album);
                    photographAlbums.sync('update', photographAlbums);
                }
                );
    }
    );
        </script>
    </body>
</html>

